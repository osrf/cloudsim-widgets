<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-sharebutton">
  <style>
    .miniButton {
      font-size: 0.8em;
      width: 7em;
    }
    .space {
      @apply(--layout-flex);
    }
    .miniButton iron-icon {
      width: 1.5em;
      margin-right: 0.2em;
    }
    .buttons {
      padding-top: 2em;
    }
    .horizontal {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }
    .vertical {
      @apply(--layout-vertical);
    }
    paper-dialog {
      position: fixed;
      padding: 1em;
      max-width: 30em;
      right: 30px;
      overflow: auto;
      text-align: center;
    }
    paper-dialog paper-button {
      color: #111
    }
    a {
      padding: 0;
    }
    paper-dropdown-menu {
      max-width: 5em;
    }
  </style>
  <template>

    <gz-grant
      id="grant"
      url={{url}}
      token={{token}}
      resource={{machine_id}}
      grantee=[[grantee]]
      read_only={{read_only}}
      on-granted="_onGranted"
      on-revoked="_onRevoked"
    ></gz-grant>

    <!-- button -->
    <paper-button raised class="miniButton" on-tap="tapOpenDialog">
      <iron-icon icon="social:share"></iron-icon>
      Share
    </paper-button>

    <!-- dialog -->
    <paper-dialog id="sharedialog" class="vertical">
      <h3>{{dialogmessage}}</h3>

      <b>Users</b>

      <div class="item horizontal">
        <div>{{owner}}</div>
        <div class="space"></div>
        <div>owner</div>
      </div>
      <template is="dom-repeat" items="{{users}}">
        <div class="item horizontal">
          <div>[[item.username]]</div>
          <div class="space"></div>
          <paper-dropdown-menu
            label="Permissions"
            on-iron-select="_onPermission">

            <paper-listbox
              class="dropdown-content"
              selected="[[_getReadOnly(item.read_only)]]"
              id="[[item.username]]"
            >
              <paper-item>read</paper-item>
              <paper-item>write</paper-item>
              <paper-item>revoke</paper-item>
            </paper-listbox>

          </paper-dropdown-menu>
        </div>
      </template>

      <div class="horizontal">
        <paper-input
          label="{{granteetxt}}"
          value={{grantee}}
          id="sharedialoguser">
        </paper-input>

        <paper-checkbox
          checked={{read_only}}
        >
        {{readonlytxt}}
        </paper-checkbox>
      </div>

      <div class="buttons">
        <paper-button raised dialog-confirm autofocus>Cancel</paper-button>
        <paper-button
          raised
          dialog-confirm
          autofocus
          id="sharedialogbutton"
          on-tap="tapGrant">
          Share
        </paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cs-sharebutton',
      attached: function() {
        console.log('cs-sharebutton widget attached!')
      },
      tapOpenDialog(e) {
        var dialog = this.$.sharedialog

        if (dialog)
          dialog.open();
        else
          console.log("Dialog not found.")
      },
      tapGrant(e) {
        if (this.grantee === '')
        {
          this.fire('error', 'Invalid user name.')
          return;
        }

        this.$.grant.grant()
      },
      _onGranted: function(e) {
        if (e.detail.success)
        {
          this.fire('notification', {msg: this.grant_success_msg, type: 'msg'})
        }
        else
        {
          this.fire('error', this.grant_failure_error)
        }
      },
      _onRevoked: function(e) {
        if (e.detail.success)
        {
          this.fire('notification', {msg: this.revoke_success_msg, type: 'msg'})
        }
        else
        {
          this.fire('error', this.revoke_failure_error)
        }
      },
      _getReadOnly: function(readonly) {
        return readonly ? 0 : 1
      },
      _onPermission: function(e) {
        var selected = (e.target.selectedItem.innerText).trim();
        if (selected == "revoke")
        {
          // Revoke all permissions
          this.$.grant.read_only = false

          this.$.grant.grantee = e.target.id
          this.$.grant.revoke()
        }

      },
      properties: {
        token: {
          type: String,
          value: 'placeholder',
          notify: true
        },
        machine_id: {
          type: String,
          value: 'placeholder',
          notify: true
        },
        machine_ip: {
          type: String,
          value: 'placeholder',
          notify: true
        },
        readonlytxt: {
          type: String,
          value: 'Read only',
          notify: true
        },
        granteetxt: {
          type: String,
          value: 'User name',
          notify: true
        },
        grantee: {
          type: String,
          notify: true
        },
        grant_success_msg: {
          type: String
        },
        grant_failure_error: {
          type: String
        },
        revoke_success_msg: {
          type: String
        },
        revoke_failure_error: {
          type: String
        },
      },
    });
  })();
  </script>
</dom-module>
