<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-sharebutton">
  <style>
    .miniButton {
      font-size: 0.8em;
      width: 7em;
    }
    .space {
      @apply(--layout-flex);
    }
    .blue {
      color: rgb(68, 138, 201);
    }
    .miniButton iron-icon {
      width: 1.5em;
      margin-right: 0.2em;
    }
    .header {
      background-color: rgb(215, 215, 215);
      color: #353535;
      margin: 0;
      padding: 1em;
    }
    .content {
      overflow: auto;
      margin: 0;
      padding: 1em;
    }
    .subcontent {
      padding-bottom: 2em;
    }
    .subheader {
      color: rgb(68, 138, 201);
    }
    .horizontal {
      @apply(--layout-horizontal);
    }
    .center {
      @apply(--layout-center);
    }
    .vertical {
      @apply(--layout-vertical);
    }
    paper-dialog {
      max-height: 40%;
      max-width: 20em;
      text-align: left;
    }
    a {
      padding: 0;
    }
    paper-dropdown-menu {
      margin-top: -1em;
      max-width: 5em;
    }
  </style>
  <template>

    <gz-grant
      id="grant"
      url={{url}}
      token={{token}}
      resource={{machine_id}}
      grantee=[[grantee]]
      readOnly=[[readOnly]]
      on-granted="_onGranted"
      on-revoked="_onRevoked"
    ></gz-grant>

    <!-- button -->
    <paper-button raised class="miniButton" on-tap="tapOpenDialog">
      <iron-icon icon="social:share"></iron-icon>
      Share
    </paper-button>

    <!-- dialog -->
    <paper-dialog id="sharedialog" class="vertical">
      <h3 class="header">{{dialogmessage}}</h3>

      <div class="content">
        <div class="subcontent">
          <!-- SHARED WITH -->
          <b class="subheader">Shared with</b>

          <!-- USERNAME / PERMISSIONS -->
          <div class="item horizontal center">
            <div class="blue">Username</div>
            <div class="space"></div>
            <div class="blue">Permissions</div>
          </div>

          <!-- OWNER -->
          <div class="item horizontal center">
            <div>{{owner}}</div>
            <div class="space"></div>
            <paper-dropdown-menu>
              <paper-listbox
                class="dropdown-content"
                selected="0"
              >
                <paper-item>write</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
          </div>

          <!-- USERS -->
          <template is="dom-repeat" items="{{users}}">
            <div class="item horizontal center">
              <div>[[item.username]]</div>
              <div class="space"></div>
              <paper-dropdown-menu
                on-iron-select="_onPermission">

                <paper-listbox
                  class="dropdown-content"
                  selected="[[_getReadOnly(item.readOnly)]]"
                  id="[[item.username]]"
                >
                  <paper-item>read</paper-item>
                  <paper-item>write</paper-item>
                  <paper-item>revoke</paper-item>
                </paper-listbox>

              </paper-dropdown-menu>
            </div>
          </template>
        </div>

        <div class="subcontent">
          <!-- SHARE WITH NEW USER-->
          <b class="subheader">Share with new user</b>

          <div class="horizontal">
            <div class="vertical">
              <!-- USERNAME INPUT-->
              <paper-input
                style="padding-right: 1em"
                label="{{granteetxt}}"
                value={{grantee}}
                id="sharedialoguser">
              </paper-input>

              <!-- READONLY CHECKBOX-->
              <paper-checkbox
                id="readonlycheckbox"
                checked={{readOnly}}
              >
              {{readonlytxt}}
              </paper-checkbox>
            </div>

            <div class="vertical">
              <div class="space"></div>

              <!-- ADD BUTTON-->
              <paper-button
                raised
                dialog-confirm
                id="sharedialogbutton"
                on-tap="tapGrant">
                Add
              </paper-button>
            </div>
          </div>
        </div>
      </div>
    </paper-dialog>

  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cs-sharebutton',
      attached: function() {
        console.log('cs-sharebutton widget attached!')
      },
      tapOpenDialog(e) {
        var dialog = this.$.sharedialog

        if (dialog)
          dialog.open();
        else
          console.log("Dialog not found.")
      },
      tapGrant(e) {
        if (this.grantee === '')
        {
          this.fire('error', 'Invalid user name.')
          return;
        }

        this.$.grant.grantee = this.$.sharedialoguser.value
        this.$.grant.readOnly = this.$.readonlycheckbox.checked
        this.$.grant.grant()
      },
      _onGranted: function(e) {
        if (e.detail.success)
        {
          this.$.grant.get()
          this.fire('notification', {msg: this.grant_success_msg, type: 'msg'})
        }
        else
        {
          this.fire('error', this.grant_failure_error)
        }
      },
      _onRevoked: function(e) {
        if (e.detail.success)
        {
          this.$.grant.get()
          this.fire('notification', {msg: this.revoke_success_msg, type: 'msg'})
        }
        else
        {
          this.fire('error', this.revoke_failure_error)
        }
      },
      _getReadOnly: function(readonly) {
        return readonly ? 0 : 1
      },
      _onPermission: function(e) {
        var selected = (e.target.selectedItem.innerText).trim();
        if (selected == "revoke")
        {
          // Revoke all permissions
          this.$.grant.readOnly = false

          this.$.grant.grantee = e.target.id
          this.$.grant.revoke()
        }
/*
        // read -> write
        else if (selected == "write")
        {
          this.$.grant.readOnly = false
          this.$.grant.grantee = e.target.id
          this.$.grant.grant()
        }
        // write -> read
        else if (selected == "read")
        {
          this.$.grant.readOnly = false
          this.$.grant.grantee = e.target.id
          this.$.grant.grant()
        }
*/
      },
      properties: {
        token: {
          type: String,
          value: 'placeholder',
          notify: true
        },
        machine_id: {
          type: String,
          value: 'placeholder',
          notify: true
        },
        machine_ip: {
          type: String,
          value: 'placeholder',
          notify: true
        },
        readonlytxt: {
          type: String,
          value: 'Read only',
          notify: true
        },
        granteetxt: {
          type: String,
          value: 'Username',
          notify: true
        },
        grantee: {
          type: String,
          notify: true
        },
        grant_success_msg: {
          type: String
        },
        grant_failure_error: {
          type: String
        },
        revoke_success_msg: {
          type: String
        },
        revoke_failure_error: {
          type: String
        },
      },
    });
  })();
  </script>
</dom-module>
