<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-srcregister">
  <style>
    :host {
      text-align: center;
    }
    .title {
      font-size: 2em;
    }
    .blue {
      background-color: rgb(68, 138, 201);
      color: #fff;
    }
    .paper-header {
      padding: 1em;
    }
    .paper-header > h1 {
      text-align: center;
    }
  </style>
  <template>

    <!-- TODO: this could be inside if loggedin, but then we can't use this.$.ajax* -->
    <iron-ajax
      id="ajaxpost"
      method="POST"
      url=[[baseUrl]]/[[route]]
      handle-as="json"
      on-response="_onRequested"
      on-error="_postError"
      content-type="application/json"
      debounce-duration="300"
    ></iron-ajax>

    <iron-ajax
      id="ajaxget"
      method="GET"
      url=[[baseUrl]]/[[route]]
      handle-as="json"
      on-response="_onPending"
      on-error="_getError"
      content-type="application/json"
      debounce-duration="300"
    ></iron-ajax>

    <paper-header-panel class="blue">
      <div class="paper-header">
        <h1 class="title">Register for the Secret Robotics Competition!</h1>
      </div>
    </paper-header-panel>

    <template is="dom-if" if="[[loggedin]]">

      <!-- NEW USERS -->
      <template is="dom-if" if="[[!pending]]">
        <h1>
          Click the following button if you'd like to participate in the competition. <br>
          An administrator will respond to the request shortly.
        </h1>
        <center>
          <paper-button raised on-click="_tapRequest">
            Request!
          </paper-button>
        </center>
      </template>

      <!-- WAITING ON APPROVAL -->
      <template is="dom-if" if="[[pending]]">
        <h1>
          You've requested to participate in this competition.
          Waiting on approval by administrators.
        </h1>
      </template>

      <!-- ALREADY IN COMPETITION -->
      <template is="dom-if" if="[[competitor]]">
        <h1>
          You're already a participant. Go to the <a href="[[baseUrl]]srckiosk">competition kiosk</a>.
        </h1>
      </template>

    </template>

    <template is="dom-if" if="[[!loggedin]]">
      <h1>
        You must have a CloudSim account to participate in the competition.
        Please login or signup above.
      </h1>
    </template>

  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cs-srcregister',
      // Attached
      attached: function() {
        console.log('cs-srcregister widget attached!')
      },

      /// Callback when request button is pressed
      _tapRequest: function() {
        this.fire('notification', "Sending request to participate in SRC.")

        this.$.ajaxpost.headers.authorization = this.token.trim()
        this.$.ajaxpost.body = {}
        return this.$.ajaxpost.generateRequest()
      },

      /// Callback when requested
      _onRequested: function(req) {

        let resp
        if (req && req.detail && req.detail.response)
          resp = req.detail.response
        else
          resp = this.$.ajaxpost.lastResponse

        if (!resp) {
          console.log("No response in request or in lastResponse")
          return;
        }

        if (!resp.success) {
          const msg = 'Could not register: ' + resp.msg

          console.log(msg)
          this.fire('error', msg)
          return
        }

        this._getPending()
        this.fire('notification', "Successfully requested to participate in SRC.")
      },

      /// Callback when there's an error on request
      _postError: function() {
        let msg = 'Error registering'

        if (this.$.ajaxpost.lastError)
          msg += ": " + this.$.ajaxpost.lastError.msg

        console.log(msg)
        this.fire('error', msg)
      },

      /// Get pending requests
      _getPending: function() {
        this.$.ajaxget.headers.authorization = this.token.trim()
        this.$.ajaxget.generateRequest()
      },

      /// Callback when we get the requests
      _onPending: function(req) {

        let resp
        if (req && req.detail && req.detail.response)
          resp = req.detail.response
        else
          resp = this.$.ajaxget.lastResponse

        if (!resp) {
          console.log("No response in request or in lastResponse")
          return;
        }

        if (!resp.success) {
          const msg = 'Could not check registration status: ' + resp.msg

          console.log(msg)
          this.fire('error', msg)
          return
        }

        this.competitor = resp.isCompetitor
        this.pending = resp.pending
      },

      /// Callback when there's an error on get
      _getError: function() {
        let msg = 'Error signing up'

        if (this.$.ajaxget.lastError)
          msg += ": " + this.$.ajaxget.lastError.msg

        console.log(msg)
        this.fire('error', msg)
      },

      /// Callback when the token has been updated
      _onTokenUpdated: function() {
        if (this.token !== "")
          this._getPending();
      },

      properties: {
        /// True if user is logged in
        loggedin: {
          type: Boolean,
          value: false,
          notify: true
        },

        /// True if user's approval to participate is pending.
        pending: {
          type: Boolean,
          value: false,
          notify: true
        },

        /// True if user is already a competitor.
        competitor: {
          type: Boolean,
          value: false,
          notify: true
        },

        /// Token for authentication
        token: {
          type: String,
          value: '',
          notify: true,
          observer: '_onTokenUpdated'
        },

        /// Route for requests
        route: {
          type: String,
          value: 'srcsignups',
        },
      },
    });
  })();
  </script>
</dom-module>
