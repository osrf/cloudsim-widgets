<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-srctasks">
  <style>
    .space {
      @apply(--layout-flex);
    }
    .horizontal {
      @apply(--layout-horizontal);
    }
    .center {
      @apply(--layout-center);
    }
    .tasks {
      padding: 1em;
      width: 15em;
      margin: 1em;
      flex-direction: column;
    }
    .tasks > h4 {
      text-align: center;
      margin: 0;
    }
    .checkpoints-header {
      font-weight: bold;
    }
    .property {
      font-weight: bold;
      color: #7a7a7a;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      /*padding: 0.5em;*/
    }
    .value {
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 8em;
      white-space: nowrap;
      /*margin: 0.5em;*/
    }
    .notification {
      font-style: italic;
    }
  </style>
  <template>

    <!-- Show the Task Results-->
    <div class="horizontal">
      <paper-material elevation="1" class="tasks">
        <h4>Task [[_printArrayNumber(taskNumber)]]</h4>

        <template is="dom-if" if="[[!started]]" restamp>
          <span class="property notification">Waiting.</span>
        </template>

        <template is="dom-if" if="[[started]]" restamp>
          <div class="horizontal center">
            <span class="property">Finished</span>
            <div class="space"></div>
            <span class="value">[[_printBoolean(task.finished)]]</span>
          </div>

          <div class="horizontal center">
            <span class="property">Timed out</span>
            <div class="space"></div>
            <span class="value">[[_printBoolean(task.timed_out)]]</span>
          </div>

          <div class="horizontal center">
            <span class="property">Start time</span>
            <div class="space"></div>
            <span class="value">[[_printTime(task.start_time)]]</span>
          </div>

          <div class="horizontal center">
            <span class="property">Elapsed</span>
            <div class="space"></div>
            <span class="value">[[_printTime(task.elapsed_time)]]</span>
          </div>

          <div class="horizontal center">
            <span class="property">Time Left</span>
            <div class="space"></div>
            <span class="value">[[_printTime(taskTimeLeft)]]</span>
          </div>

          <p class="checkpoints-header">Checkpoints</p>

          <template is="dom-repeat" items="{{task.checkpoints_completion}}">
            <div class="horizontal center">
              <span class="property">Checkpoint [[_printArrayNumber(index)]]</span>
              <div class="space"></div>
              <span class="value">[[_printTime(item)]]</span>
            </div>
          </template>
        </template>
      </paper-material>
    </div>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cs-srctasks',

      // Attached
      attached: function() {
      },

      // Print an incremented index.
      _printArrayNumber: function(number) {
        return number + 1;
      },

      // Print booleans as Yes or No.
      _printBoolean: function(val) {
        if (val) {
          return "Yes";
        } else {
          return "No";
        }
      },

      // Print time in hh:mm:ss.milliseconds format.
      _printTime: function(seconds) {
        if (seconds === undefined) {
          return "Waiting";
        }
        // Calculate hh:mm:ss with the given seconds.
        var hh = Math.floor(seconds/3600);
        var mm = Math.floor((seconds-(hh*3600))/60);
        var ss = Math.floor(seconds - hh*3600 - mm*60);
        var milliseconds = Math.floor((seconds - Math.floor(seconds)) * 1000);
        // Pad with zeros.
        if (hh < 10) {
          hh = "0" + hh;
        }
        if (mm < 10) {
          mm = "0" + mm;
        }
        if (ss < 10) {
          ss = "0" + ss;
        }
        if (milliseconds < 1) {
          milliseconds = "000"
        } else {
          if (milliseconds < 10) {
            milliseconds = "00" + milliseconds;
          } else {
            if (milliseconds < 100) {
              milliseconds = "0" + milliseconds;
            }
          }
        }
        return hh + ":" + mm + ":" + ss + "." + milliseconds;
      },

      // Calculate the time left for the current task.
      _calculateTimeLeft: function(task, number, length) {
        return length[number] - task.elapsed_time;
      },

      // Check whether the task started or not.
      _hasStarted: function(task) {
        return (task.length != 0) && (task.start_time !== undefined);
      },

      properties: {
        task: {
          type: Array,
          value: [],
          notify: true,
        },
        taskNumber: {
          type: Number,
          notify: true,
        },
        taskLength: {
          type: Array,
          value: [1800, 3600, 7200],
          readOnly: true,
        },
        taskTimeLeft: {
          type: Number,
          notify: true,
          computed: '_calculateTimeLeft(task, taskNumber, taskLength)'
        },
        started: {
          type: Boolean,
          value: false,
          notify: true,
          computed: '_hasStarted(task)'
        },
      },
    });
  })();
  </script>
</dom-module>
