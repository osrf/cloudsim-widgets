<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-src">
  <style>
    .blue {
      background-color: rgb(68, 138, 201);
      color: #fff;
    }
    .red {
      background-color: rgb(201, 68, 68);
      color: #fff;
    }
    .green {
      background-color: rgb(20, 255, 20);
      color: #fff;
    }
    .paper-header {
      padding: 1em;
    }
    .paper-header > h1 {
      text-align: center;
    }
    .content {
      padding: 3em;
    }
    .horizontal {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }
    .horizontal paper-input {
      @apply(--layout-start);
    }
    .horizontal > h1 {
      margin-right: 2em;
    }
    .vertical {
      @apply(--layout-vertical);
    }
    .tasks {
      padding: 1em;
      width: 15em;
      height: 13em;
      margin: 1em;
      margin-top: 2em;
    }
    .tasks h4{
      text-align: center;
      margin: 0;
    }
    .taskDisabled {
      color: #bbb;
    }
    #items{
        margin: 3em;
    }
    .tasks paper-button{
      @apply(--layout-vertical);
      @apply(--layout-right);
    }
    .spacer {
      @apply(--layout-flex);
    }
    paper-fab {
      position: absolute;
      top: -20px;
      right: -20px;
    }
    paper-button[disabled] {
      background-color: #bababa;
      color: rgb(96, 96, 96);
    }
  </style>
  <template>

    <iron-pages attr-for-selected="data-route" selected="{{route}}">

      <section data-route="overview">

        <paper-header-panel class="blue">
          <div class="paper-header">
            <h1>Secret Robotics Competition</h1>
          </div>
        </paper-header-panel>

        <div class="content">
          <p>
            Text about competition
            Text about competition
            Text about competition
            Text about competition
            Text about competition
            Text about competition
            Text about competition
            Text about competition
            Text about competition
            Text about competition
          </p>

          <paper-button raised class="raised" id="registerbutton" on-tap="tapRegister">
            <iron-icon icon="social:person-add"></iron-icon>
            Register for competition
          </paper-button>
        </div>
      </section>

      <section data-route="kiosk">

        <paper-header-panel class="blue">
          <div class="paper-header">
            <h1>Secret Robotics Competition</h1>
            <p>The competition tasks are now available!
               To compete, follow the steps below.
               You must complete all tasks by [date].
               See the
               <a href="{{baseUrl}}src-overview">Overview</a>
               for the complete list of rules.</p>
          </div>
        </paper-header-panel>

        <div class="content">
          <div class="vertical">
            <!-- 1 -->
            <div class="horizontal">
              <h1>
                1
              </h1>
              <div>
                Link to your code repository:
              </div>
              <paper-input label="url" id="repoUrl"></paper-input>
              <paper-button
                raised
                id="addbutton"
                class="raised blue"
                on-tap="tapAddRepo">
                Add
              </paper-button>
              <paper-button
                raised
                id="removebutton"
                style="display: none"
                class="raised red"
                on-tap="tapRemoveRepo">
                Remove
              </paper-button>
            </div>
            <!-- 2 -->
            <div class="horizontal">
              <h1>
                2
              </h1>
              <div>
                Complete the competition tasks. Once you complete a task, the next will become available.
              </div>
            </div>

           <iron-list items="[[tasks]]" as="task" grid>
              <template>
                <div>
                  <paper-material class="tasks taskDisabled" id="task[[taskNumber(task)]]">
                    <h4>Task {{taskNumber(task)}}</h4>
                    <div>
                      <p>Description: {{task.description}}</p>
                      <p id="status[[taskNumber(task)]]">Status: Unavailable</p>
                      <p>Time limit:</p>
                    </div>
                    <div class="horizontal">
                      <div class="spacer"></div>
                      <paper-button
                        raised
                        disabled
                        class="raised blue"
                        id="startbutton[[taskNumber(task)]]"
                        on-tap="tapStart">
                        Start
                      </paper-button>
                      <paper-button
                        raised
                        class="raised red"
                        id="stopbutton[[taskNumber(task)]]"
                        on-tap="tapStop"
                        style="display: none">
                        Stop
                      </paper-button>
                    </div>
                    <paper-fab
                      mini
                      disabled
                      class="blue"
                      id="runningbutton[[taskNumber(task)]]"
                      icon="icons:refresh"
                      style="display: none">
                    </paper-fab>
                    <paper-fab
                      mini
                      disabled
                      class="green"
                      id="completebutton[[taskNumber(task)]]"
                      icon="icons:check"
                      style="display: none">
                    </paper-fab>
                  </paper-material>
                </div>
              </template>
            </iron-list>
            <!-- 3 -->
            <div class="horizontal">
              <h1>
                3
              </h1>
              <div>
                Check your scores and download task log files from the Leaderboard.
              </div>
            </div>
          </div>
        </div>
      </section>

      <section data-route="leaderboard">
        <paper-header-panel class="blue">
          <div class="paper-header">
            <h1>Robotics Competition</h1>
            <p>See your scores!</p>
          </div>
        </paper-header-panel>
      </section>
    </iron-pages>

  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cs-src',
      // Attached
      attached: function() {
        this.push('tasks', {'description': 'First task'})
        this.push('tasks', {'description': 'Second task'})
        this.push('tasks', {'description': 'Third task'})
        console.log('cs-src widget attached!')
      },
      taskNumber: function(task) {
        return this.tasks.indexOf(task) + 1;
      },
      tapAddRepo: function(e) {
        // TODO: Client-side check if repo is ok?
        if (this.$.repoUrl.value === '')
        {
          // TODO: Print message about empty url
          return;
        }
        // TODO: Send repo info to server, wait for reply saying it's ready to run
        this._taskStatus(1, 'Ready')
        this.$.removebutton.style.display = ''
        this.$.addbutton.style.display = 'none'
      },
      tapRemoveRepo: function(e) {
        // TODO: Send request to server

        // Restore initial state
        this.$.removebutton.style.display = 'none'
        this.$.addbutton.style.display = ''
        for (var i = 1; i <= this.tasks.length; ++i)
        {
          this._taskStatus(i, 'Unavailable')
        }
      },
      tapStart: function(e) {
        let buttonId = e.target.id
        let taskNumber = buttonId.substring(11, buttonId.length)
        let taskInt = parseInt(taskNumber, 10)

        // TODO: Send request to start. On successful reply:
        this._taskStatus(taskInt, 'Running')
      },
      tapStop: function(e) {
        let buttonId = e.target.id
        let taskNumber = buttonId.substring(10, buttonId.length)
        let taskInt = parseInt(taskNumber, 10)

        // TODO: Send request to start. On successful reply:
        this._taskStatus(taskInt, 'Complete')
        this._taskStatus(taskInt+1, 'Ready');
      },
      _taskStatus(taskNumber, taskStatus) {
        if (taskNumber > this.tasks.length)
        {
          console.log('Error: task number [' + taskNumber +
              '] is larger than task length [' + this.tasks.length + ']')
          return;
        }

        let stopDisplay = (taskStatus == 'Running') ? '' : 'none';
        let startDisplay = (taskStatus == 'Running') ? 'none' : '';
        let runningDisplay = stopDisplay
        let completeDisplay = (taskStatus == 'Complete') ? '' : 'none';
        let startEnabled = (taskStatus == 'Ready') ? true : false;

        if (taskStatus == 'Unavailable')
        {
          this.querySelector('#task' + taskNumber).classList.add('taskDisabled');
        }
        else
        {
          this.querySelector('#task' + taskNumber).classList.remove('taskDisabled');
        }

        this.querySelector('#stopbutton' + taskNumber).style.display = stopDisplay
        this.querySelector('#startbutton' + taskNumber).style.display = startDisplay
        this.querySelector('#startbutton' + taskNumber).disabled = !startEnabled
        this.querySelector('#runningbutton' + taskNumber).style.display = runningDisplay
        this.querySelector('#completebutton' + taskNumber).style.display = completeDisplay
        this.querySelector('#status' + taskNumber).textContent = 'Status: ' + taskStatus
      },
      properties: {
        tasks: {
          type: Array,
          value: [],
          notify: true
        },
      },
    });
  })();
  </script>
</dom-module>
