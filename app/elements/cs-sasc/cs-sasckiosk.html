<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-sasckiosk">
  <style>
    :root {
      --paper-tab-ink: #fff;
      --paper-tabs-selection-bar-color: #fff;
      --paper-tabs: {
        color: #fff;
      }
    }
    .title {
      font-size: 2em;
    }
    .space {
      @apply(--layout-flex);
    }
    .about-half {
      min-width: 45%;
      margin-right: 2%;
      margin-left: 2%;
    }
    .horizontal {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }
    .vertical {
      @apply(--layout-vertical);
      @apply(--layout-center);
    }
    .blue {
      background-color: rgb(68, 138, 201);
      color: #fff;
    }
    .white {
      background-color: #fff;
      color: #222;
    }
    .grey {
      background-color: #d7d7d7;
      color: rgb(68, 138, 201);
    }
    .floating {
      margin-top: -1.2em;
      margin-left: 1em;
      z-index: 1000;
    }
    .paper-header {
      padding: 1em;
    }
    .paper-header > h1 {
      text-align: center;
    }
    .paper-header > h4 {
      margin: 0;
      text-align: center;
    }
    .paper-header > p {
      margin-bottom: 0;
      color: #ddd;
      text-align: center;
    }
    .content {
      padding: 1em;
      height: 100%;
    }
    paper-tabs {
      margin-top: -69px;
      margin-left: 20px;
    }
    .new-content {
      width: 50%;
    }
    .box-header > h4 {
      color: #eee;
    }
    .box-header {
      background-color: rgb(68, 138, 201);
      color: #353535;
      margin: 0;
      padding-right: 1em;
      padding-left: 1em;
    }
    .box-content {
      overflow: auto;
      margin: 0;
      padding: 1em;
    }
    .box {
      max-width: 70%;
      min-width: 30%;
      margin-top: 1em;
    }
    .full {
      min-width: 100%;
    }
  </style>
  <template>

    <!-- For launching machines -->
    <gz-resources
      id="launchresources"
      url="[[portalurl]]"
      token="[[token]]"
      resourcename="simulator"
      on-created="_onLaunched"
    ></gz-resources>

    <!-- For managing rounds -->
    <gz-resources
      id="roundsresources"
      url="[[baseUrl]]"
      token="[[token]]"
      resourcename="sascround"
      on-created="_onNewRound"
      on-resourcesupdated="_onAllRounds"
      on-updated="_onRoundUpdated"
    ></gz-resources>

    <paper-header-panel class="blue">
      <div class="paper-header">
        <h1 class="title">Rounds</h1>
      </div>
    </paper-header-panel>

    <paper-fab
      mini
      class="grey floating"
      icon="icons:add"
      title="Start a new round"
      on-tap="_onNew"
    ></paper-fab>

    <paper-tabs scrollable attr-for-selected="value" selected="{{currentpage}}">
      <template is="dom-repeat" items="{{rounds}}">
        <paper-tab value="[[item.data.name]]">[[item.data.name]]</paper-tab>
      </template>
    </paper-tabs>

    <iron-pages attr-for-selected="data-route" selected="{{currentpage}}">

      <section data-route="empty">
        <center>
          <p>You have no rounds running.</p>
          <paper-button flat on-tap="_onNew">Start one now</paper-button></p>
        </center>
      </section>

      <section data-route="new">
        <center>
          <div class="new-content">
            <p>Start a new round.</p>

            <paper-input value="{{roundname}}" label="Round name" required></paper-input>

            <div class="horizontal">
              <p>Blue team:</p>
              <div class="space"></div>
              <paper-dropdown-menu label="Competitor">
                <paper-listbox
                  class="dropdown-content"
                  attr-for-selected="value"
                  selected="{{blueuser}}"
                >
                  <template is="dom-repeat" items="[[competitors]]">
                    <paper-item value="[[item]]">[[item]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </div>

            <div class="horizontal">
              <p>Gold team:</p>
              <div class="space"></div>
              <paper-dropdown-menu label="Competitor">
                <paper-listbox
                  class="dropdown-content"
                  attr-for-selected="value"
                  selected="{{golduser}}"
                 >
                  <template is="dom-repeat" items="[[competitors]]">
                    <paper-item value="[[item]]">[[item]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </div>

            <paper-button
              raised
              class="blue"
              on-tap="_onContinue"
            >Continue</paper-button></p>

          </div>
        </center>
      </section>

      <template is="dom-repeat" items="{{rounds}}">
        <section data-route="[[item.data.name]]">
          <center>

            <!-- ARBITER -->
            <paper-material elevation="1" class="box">
              <div class="box-header horizontal">
                <h4>Arbiter: "[[item.data.name]]"</h4>
                <div class="space"></div>
                <template is="dom-if" if="{{_isNotLaunched(item.data.arbiter.status)}}">
                  <paper-button
                    raised
                    class="white"
                    on-tap="_onLaunchArbiter"
                  >
                    Launch
                  </paper-button>
                </template>
              </div>
              <div class="box-content">
                <div class="vertical">
                  <div class="horizontal">
                    Status: [[item.data.arbiter.status]]
                    <div class="space"></div>
                  </div>
                  <template is="dom-if" if="{{_isRunning(item.data.arbiter.status)}}">
                    <div class="horizontal">
                      Public IP:
                      [[item.data.arbiter.machine_ip]]
                    </div>
                    <div class="horizontal">
                      SSH keys:
                      <cs-downloadkeysbutton
                        simurl="[[item.data.arbiter.machine_ip]]"
                        token="[[token]]"
                      ></cs-downloadkeysbutton>
                    <div>
                  </template>
                <div>
                <div class="space"></div>
              </div>
            </paper-material>
            <!-- /ARBITER -->

          </center>

          <div class="horizontal box full">

            <!-- BLUE TEAM -->
            <div class="about-half">
              <paper-header-panel class="blue">
                <div class="paper-header">
                  <h4>Blue</h4>
                  <p>[[item.data.blueuser]]</p>
                </div>
              </paper-header-panel>
              <div class="content">
                Must launch arbiter before teams
              </div>
            </div>

            <!-- GOLD TEAM -->
            <div class="about-half">
              <paper-header-panel class="blue">
                <div class="paper-header">
                  <h4>Gold</h4>
                  <p>[[item.data.golduser]]</p>
                </div>
              </paper-header-panel>
              <div class="content">
                Must launch arbiter before teams
              </div>
            </div>

          </div>
        </section>
      </template>

    </iron-pages>

  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cs-sasckiosk',

      // Attached
      attached: function() {
        console.log('cs-sasckiosk widget attached!')

        this.competitors = [
          "team1@email.com",
          "team2@email.com",
          "team3@email.com",
        ]
      },

      // Callback when the token has been updated
      _onTokenUpdated: function() {
        if (this.token !== "") {
          this._getRounds()
        }
      },

      // Get list of all rounds for this user
      _getRounds: function() {
        this.$.roundsresources.getAll()
      },

      // Callback from widgets server with all rounds for this user
      _onAllRounds: function(e) {
        this.set('rounds', e.detail)

        if (this.rounds.length == 0)
          this.currentpage = "empty"
        else if (this.currentpage == "" || this.currentpage == "empty")
          this.currentpage = this.rounds[0].data.name
      },

      // Go to page to start new round
      _onNew: function() {
        this.currentpage = "new"
      },

      // Continue starting new round
      _onContinue: function() {
        if (this.roundname === "" ||
            !this.blueuser ||
            !this.golduser) {

          this.fire('error', 'No fields can be empty.')
          return
        }

        let data = {
          name: this.roundname,
          blueuser: this.blueuser,
          golduser: this.golduser,
          arbiter: {
            status: 'NOT LAUNCHED'
          },
        }

        this.$.roundsresources.create(data);

        this.fire('notification', 'Sending request to start round "' + this.roundname + '".')
      },

      // Callback from widgets server when a new round has been
      // registered
      _onNewRound: function(e) {
        let resp = e.detail

        if (!resp.success) {
          const msg = 'Could not start round: ' + resp.msg

          console.log(msg)
          this.fire('error', msg)
          return
        }

        this.push('rounds', resp.result)

        this.currentpage = resp.result.data.name

        this.fire('notification', 'Started round "' + resp.result.data.name + '".')
      },

      // When arbiter launch button is pressed
      _onLaunchArbiter(e) {

        const that = this
        let currentRound = this.rounds.find(function(element) {
          return (element.data.name === that.currentpage)
        })

        let data =  {
          token: this.token,
          region: "us-west-1",
          image: "ami-4b37752b",
          hardware: "t2.small",
          options: {
            role: 'arbiter',
            keyName: currentRound.name,
            keyServerUrl: this.keysurl,
            token: this.token,
          }
        }

        this.$.launchresources.create(data);
        this.fire('notification', {msg:
            "Request to launch an arbiter for \"" + this.currentpage +
            "\" has been sent.", type: "msg"})
      },

      // Callback once machine has been launched
      _onLaunched: function(e) {
        let success = e.detail.success
        let msg = e.detail.message

        if (success != undefined && success == false)
        {
          this.fire('notification', {msg: msg, type: "error"})
          return
        }

        // Save arbiter id to widgets
        const that = this
        let i = 0;
        for (; i < this.rounds.length; i++) {
          if (this.rounds[i].data.name === this.currentpage) {
            break
          }
        }

        let data = {
          arbiter: {
            id: e.detail.id,
            ip: e.detail.machine_ip,
            status: e.detail.status
          }
        }

        this.$.roundsresources.update(this.rounds[i].name, data)

        this.fire('notification', {msg: 'Arbiter for "' + this.currentpage +
            '" has been launched.', type: "msg"})
      },

      // Callback when a round has been updated
      _onRoundUpdated: function(e) {
        console.log("UPDATED")
        console.log(e.detail)



        // TODO: Use portal resources websocket to keep updating
      },

      // Check if it's running
      _isRunning: function(itemStatus) {
        return itemStatus == 'RUNNING' ? true : false;
      },

      // Check if it's not launched
      _isNotLaunched: function(itemStatus) {
        return itemStatus == 'NOT LAUNCHED' ? true : false;
      },

      properties: {
        rounds: {
          type: Array,
          value: [],
          notify: true
        },
        currentpage: {
          type: String,
          value: 'empty',
          notify: true
        },
        portalurl: {
          type: String,
          value: '',
          notify: true
        },
        keysurl: {
          type: String,
          value: '',
          notify: true
        },
        token: {
          type: String,
          value: '',
          notify: true,
          observer: '_onTokenUpdated'
        },
      },
    });
  })();
  </script>
</dom-module>
