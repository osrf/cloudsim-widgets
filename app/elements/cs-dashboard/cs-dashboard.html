<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-dashboard">
  <style>
      :host {
        display: block;
        padding-top: 3em;
        @apply(--paper-font-common-base);
      }
      app-toolbar {
        background-color: var(--google-green-700);
        box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.3);
        font-weight: bold;
        color: white;
        z-index: 1;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
      }
      app-toolbar paper-icon-button {
        --paper-icon-button-ink-color: white;
      }
      iron-list {
        padding-top: 64px;
        padding-bottom: 64px;
        --iron-list-items-container: {
          max-width: 90%;
          margin: auto;
          margin-bottom: 60px;
        }
      }
      a {
        text-decoration: none;
      }
      .miniButton {
        font-size: 0.8em;
        width: 7em;
      }
      .miniButton iron-icon {
        width: 1.5em;
        margin-right: 0.2em;
      }
      .item {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        padding: 20px;
        background-color: white;
        margin-bottom: 10px;
      }
      .pad {
        padding: 0 16px;
        @apply(--layout-flex);
        @apply(--layout-center);
        @apply(--layout-horizontal);
      }
      .pad > div {
        padding-right: 1em;
      }
      .machineInfo {
        color: gray;
        text-align: left;
        font-size: 0.8em;
      }
      .vertical {
        @apply(--layout-vertical);
      }
      .horizontal {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .iconPadding {
        padding-right: 1em;
      }
      .bigIcon {
        --iron-icon-height: 50px;
        --iron-icon-width: 50px;
      }
      .blueIcon {
        --iron-icon-fill-color: rgb(68, 138, 201);
      }
      .killButton > iron-icon {
        --iron-icon-fill-color: #f00;
      }
      .launchingStatus > iron-icon {
        --iron-icon-fill-color: #ff0;
      }
      .runningStatus > iron-icon {
        --iron-icon-fill-color: #00f;
      }
      .terminatingStatus > iron-icon {
        --iron-icon-fill-color: #f00;
      }
      .spacer {
        @apply(--layout-flex);
      }
      @media (max-width: 460px) {
        paper-toolbar .bottom.title {
          font-size: 14px;
        }
      }

      .horizontal-3 {
        padding: 1em;
        text-align: left;
      }

      paper-material {
        margin: auto;
        width: 40%;
        text-align: center;
        padding: 1em;
      }
      paper-dialog {
        position: fixed;
        padding: 1em;
        max-width: 30em;
        right: 30px;
        overflow: auto;
        text-align: center;
      }
      paper-dialog paper-button {
        color: #111
      }
      #launchArea {
        width: 30%;
      }

      #launchbutton {
        background-color: rgb(68, 138, 201);
        color: white;
        padding: 0.5em;
      }
      paper-tooltip {
        --paper-tooltip: {
          width: 30em;
          text-align: left;
          font-size: 0.8em;
          position: absolute;
          top: -15em;
          left: -20em;
        }
      }
  </style>
  <template>

    <!-- For launching new machines-->
    <gz-simulatorlauncher
      id="simulatorlauncher"
      url={{portalurl}}
      token={{token}}
      on-launched="onLaunched"
      on-killed="onKilled"
    ></gz-simulatorlauncher>

    <!-- For retrieving list of machines-->
    <gz-simulatorq
      id="simulatorq"
      token={{token}}
      on-simulatorqupdated="onSimulatorqUpdated"
      url={{portalurl}}
    ></gz-simulatorq>

    <div class="horizontal">
      <div id="adminArea">
        <cs-serverstatus></cs-serverstatus>
      </div>

      <paper-material elevation="1" id="launchArea">

        <h1><iron-icon icon="hardware:computer" class="iconPadding"></iron-icon>Launch a machine</h1>

        <div class="horizontal">
          <paper-dropdown-menu
            label="Machine types"
            selected="0"
            on-iron-select="_machineSelected">

            <paper-listbox class="dropdown-content" attr-for-selected="machine" selected="small">
              <paper-item machine="small">small</paper-item>
              <paper-item machine="gpu">gpu</paper-item>
            </paper-listbox>

          </paper-dropdown-menu>

          <div style="padding: 1em" hidden>
            <paper-input label="Region" id="region" value="us-west-1"></paper-input>
            <paper-input label="Machine image" id="machineImage" value="ami-e5eea885"></paper-input>
            <paper-input label="Hardware" id="hardware" value="t2.small"></paper-input>
          </div>

          <paper-button raised id="launchbutton" on-tap="tapLaunch">
            Launch!
          </paper-button>
        </div>
      </paper-material>
    </div>
    <iron-list id="list" items="[[listitems]]" as="item" selection-enabled multi-selection>
      <template>
        <paper-material elevation="2" style="margin: 1em">
          <div id="item[[item.id]]">
            <div class$="[[getClassForItem(item, selected)]]" tabindex$="[[tabIndex]]">
              <iron-icon class="bigIcon" icon="hardware:computer"></iron-icon>
              <div class="pad">
                <template is="dom-if" if="{{!isTerminating(item.status)}}">
                  <div><a href="https://{{item.machine_ip}}" target="_blank">[[item.machine_ip]]</a></div>
                </template>

                <div class$="[[getStatusClass(item.status)]]">
                  <!-- <iron-icon icon="icons:cloud"></iron-icon> -->
                  [[item.status]]
                </div>
                <div class="machineInfo">
                  <b>Launch date</b>: [[prettyDate(item.launch_date)]]<br>
                  <template is="dom-if" if="{{isTerminating(item.status)}}">
                    <b>Termination date</b>: [[prettyDate(item.termination_date)]]<br>
                  </template>
                  <!--<b>Owner</b>: [[item.owner.username]]<br>
                  <b>Users</b>: [[item.users]]<br>
                  <b>ID</b>: [[item.id]]<br>
                  <b>Simulations</b>: [[item.simulations]]<br>-->
                 </div>
              </div>
              <template is="dom-if" if="{{!isTerminating(item.status)}}">
<!--
                <gz-simulator
                  id="gzsimulator[[item.id]]"
                  url="https://{{item.machine_ip}}"
                  token={{token}}
                ></gz-simulator>
-->
                <div class="vertical">
                  <template is="dom-if" if="{{isRunning(item.status)}}">
                    <a href=https://{{item.machine_ip}}/keys.zip?token={{token}} target="_blank" tabindex="" style="color:inherit">
                      <paper-button raised class="keysButton miniButton" id="keysbutton[[item.id]]">
                        <iron-icon icon="icons:cloud-download" class="blueIcon"></iron-icon>
                        Keys
                      </paper-button>
                    </a>
                    <paper-button raised class="shareButton miniButton" on-tap="tapShare" id="sharebutton[[item.id]]">
                      <iron-icon icon="social:share"></iron-icon>
                      Share
                    </paper-button>
                  </template>
                  <paper-button raised class="killButton miniButton" on-tap="tapKill" id="killbutton[[item.id]]">
                    <iron-icon icon="icons:close"></iron-icon>
                    Kill
                  </paper-button>
                 </div>
              </template>
            </div>

            <template is="dom-if" if="{{isRunning(item.status)}}">
              <gz-cmd
                title="{{item.machine_ip}}"
                url="https://{{item.machine_ip}}"
                token={{token}}
                cmd="gzserver --verbose"
                gui
                style="padding: 1em; height: 6em; overflow: auto"
              ></gz-cmd>
            </template>
          </div>
<!--
          <paper-tooltip for="item[[item.id]]" animation-delay="0">
            <b>Launch date</b>: [[prettyDate(item.launch_date)]]<br>
            <template is="dom-if" if="{{isTerminating(item.status)}}">
              <b>Termination date</b>: [[prettyDate(item.termination_date)]]<br>
            </template>
            <b>Owner</b>: [[item.owner.username]]<br>
            <b>Machine ID:</b>: [[item.machine_id]]<br>
            <b>Region:</b>: [[item.region]]<br>
          </paper-tooltip>
-->
        </paper-material>

        <paper-dialog id="sharedialog[[item.id]]">
          Share machine <a href="https://{{item.machine_ip}}" target="_blank">[[item.machine_ip]]</a> with user:
          <paper-input
             label="User name"
             id="sharedialoguser[[item.id]]">
          </paper-input>
          <div class="buttons">
            <paper-button raised dialog-confirm autofocus>Cancel</paper-button>
            <paper-button
              raised
              dialog-confirm
              autofocus
              id="sharedialogbutton[[item.id]]"
              on-tap="tapShareUser">
              Share
             </paper-button>
          </div>
        </paper-dialog>
      </template>
    </iron-list>

  </template>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.js"></script>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cs-dashboard',
      // Attached
      attached: function() {
        // TODO: separate launch and admin logic
        this.$.launchArea.style.display = (this.canLaunch == 'true' ? '' : 'none');
        this.$.adminArea.style.display = (this.canLaunch == 'true' ? '' : 'none');

        // Listen to events
        var that = this;
        window.addEventListener('login', function(e) {
          that.token = e.detail.token;

          // FIXME: hardcoded admin can launch machines
          that.canLaunch = (e.detail.user === "admin" ? 'true' : 'false')

          // Initialize socket
          if (that.socket == undefined)
          {
            console.log("cs-dashboard, socket, portalurl: " + that.portalurl + " token: " + that.token)
            that.socket = io(that.portalurl, {query: {token: that.token}})

            that.socket.on('connect', function () {
              console.log("Socket connected.")
              that.socket.on('simulator_launch', function (simulator) {
                that.$.simulatorq.tapGet();
              })
              that.socket.on('simulator_status', function (simulator) {
                that.$.simulatorq.tapGet();
              })
              that.socket.on('simulator_terminate', function (simulator) {
                that.$.simulatorq.tapGet();
              })
            })
            that.socket.on('connect_error', function (e) {
              console.log("cs-dashboard: FAILED TO CONNECT PORTAL WEBSOCKET")
              console.log(e)
            })
          }

          that.tapRefresh()
        });

        window.addEventListener('logout', function(e) {
          that.token = "";
        });

        console.log('cs-dashboard widget attached!')
      },
      tapLaunch() {
        let region = this.$.region.value;
        let machineImage = this.$.machineImage.value;
        let hardware = this.$.hardware.value;

        if (region == "" ||
            machineImage == "" ||
            hardware == "")
        {
          this.fire('notification', {msg: "Missing some information. Machine can't be launched.", type: "error"})
          return;
        }

        // Send request to gz-simulatorlauncher
        this.$.simulatorlauncher.launchMachine(region, machineImage, hardware);
        this.fire('notification', {msg: "Request to launch machine has been sent.", type: "msg"})
      },
      onLaunched: function(e) {
        this.tapRefresh()

        let success = e.detail.success
        let msg = e.detail.message

        if (!success)
        {
          this.fire('notification', {msg: msg, type: "error"})
          return;
        }
      },
      tapKill(e) {
        let id = e.target.id
        id = id.substring(10)

        // Send request to gz-simulatorlauncher
        this.fire('notification',
            {msg: "Request to kill machine has been sent.", type: "msg"})
        this.$.simulatorlauncher.killMachine(id);
      },
      tapShare(e) {
        let id = e.target.id
        id = id.substring(11)

        var dialog = this.querySelector('#sharedialog' + id);

        if (dialog)
          dialog.open();
        else
          console.log("Dialog [#sharedialog" + id + "] not found.")
      },
      tapShareUser(e) {
        let id = e.target.id
        id = id.substring(17)

        var inp = this.querySelector('#sharedialoguser' + id);

        if (!inp)
          return;

        if (inp.value == '')
          this.fire('notification', {msg: 'Invalid user name."', type: 'msg'})

        // TODO: Send request to share machine. On success, do:
        this.fire('notification', {msg: 'Shared machine with user "' +
            inp.value + '"', type: 'msg'})
      },
      onKilled: function(e) {
        this.tapRefresh()
      },
      onSimulatorqUpdated: function(e) {
        if (e.detail.success)
        {
          this.updateList(e.detail.items);
        }
      },
      updateList: function(items) {
        this.sortByReverseLaunchDate(items);

        // The portal sends periodic updates even if there are no changes.
        // Check if there are status updates
        if (items.length == this.listitems.length)
        {
          let i = 0;
          while (i < items.length && items[i].status == this.listitems[i].status &&
              items[i].machine_ip == this.listitems[i].machine_ip)
          {
            ++i;
          }
          if (i == items.length)
            return;
        }

        // Make sure we're not calling this multiple times before the timeouts
        if (this.updateCount == this.updateTarget)
        {
          // Counters
          this.updateCount = 0;
          this.updateTarget = items.length;

          // Reset list
          this.splice("listitems", 0, this.listitems.length)

          // Push each item
          items.forEach(function(item, index){

            // Polymer issue #3682
            // https://github.com/Polymer/polymer/issues/3682
            // Consecutive updates only work asynchronously
            var that = this;
            setTimeout(function () {
              that.push('listitems', item);
              that.updateCount = that.updateCount + 1
            }, 100);

          }.bind(this));
        }
      },
      tapRefresh() {
        this.$.simulatorq.tapGet();
        this.$.launchArea.style.display = (this.canLaunch == 'true' ? '' : 'none');
        this.$.adminArea.style.display = (this.canLaunch == 'true' ? '' : 'none');
      },
      getClassForItem: function(item, selected) {
        return selected ? 'item expanded' : 'item';
      },
      getStatusClass: function(itemStatus) {
        let itemClass = 'launchingStatus'
        if (itemStatus == 'RUNNING')
          itemClass = 'runningStatus'
        else if (itemStatus == 'TERMINATING' || itemStatus == 'TERMINATED')
          itemClass = 'terminatingStatus'
        else if (itemStatus == 'LAUNCHING')
          itemClass = 'launchingStatus'
        return itemClass;
      },
      isRunning: function(itemStatus) {
        return itemStatus == 'RUNNING' ? true : false;
      },
      isTerminating: function(itemStatus) {
        return (itemStatus == 'TERMINATING' || itemStatus == 'TERMINATED') ? true : false;
      },
      prettyDate: function(date) {
        let d = new Date(date);
        return d.toString();
      },
      sortByReverseLaunchDate: function(items) {
        items.sort(this.compareDates)
      },
      compareDates: function(a, b) {
        let aDate = new Date(a.launch_date)
        let bDate = new Date(b.launch_date)
        if (aDate < bDate)
            return 1;
        if (aDate > bDate)
            return -1;
        return 0;
      },
      _machineSelected: function(e) {
        var selectedItem = e.target.selectedItem;
        if (!selectedItem)
          return;
        var machine = e.target.selectedItem.innerText;

        this.$.region.value = "us-west-1"
        if (machine == "small")
        {
          this.$.machineImage.value = "ami-e5eea885"
          this.$.hardware.value = "t2.small"
        }
        else if (machine == "gpu")
        {
          this.$.machineImage.value = "ami-610c7801"
          this.$.hardware.value = "g2.2xlarge"
        }
      },
      properties: {
        portalurl: {
          type: String,
          value: 'https://localhost:4000',
          notify: true
        },
        token: {
          type: String,
          value: 'placeholder',
          notify: true
        },
        listitems: {
          type: Array,
          value: [],
          notify: true
        },
        canLaunch: {
          type: String,
          value: 'false',
          notify: true
        },
      },
    });
  })();
  </script>
</dom-module>
