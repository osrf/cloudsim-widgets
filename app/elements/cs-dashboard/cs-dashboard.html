<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-dashboard">
  <style>
      :host {
        display: block;
        padding-top: 3em;
        @apply(--paper-font-common-base);
      }
      .horizontal {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .center {
        margin: auto;
        width: 30%;
      }
  </style>
  <template>

    <div class="horizontal">
      <template is="dom-if" if="{{isadmin}}">
        <cs-serverstatus
          class="center"
        ></cs-serverstatus>
      </template>

      <template is="dom-if" if="{{hasmachinelauncher}}">
        <cs-machinelauncher
          class="center"
          portalUrl=[[portalurl]]
          token=[[token]]
        ></cs-machinelauncher>
      </template>
    </div>

    <cs-machinelist
      portalurl="[[portalurl]]"
      currentuser="[[currentuser]]"
    ></cs-machinelist>

    <div class="horizontal">
      <template is="dom-if" if="[[!issrcuser]]">
        <cs-srcbanner
          class="center"
        ></cs-srcbanner>
      </template>

      <template is="dom-if" if="[[!isariacuser]]">
        <cs-ariacbanner
          class="center"
        ></cs-ariacbanner>
      </template>
    </div>

  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cs-dashboard',
      // Attached
      attached: function() {
        console.log('cs-dashboard widget attached!')
      },
      _currentUserChanged: function() {
        // TODO: Currently admin is hard-coded, use gz-grant to check if user
        // has launch permission
        this.isadmin = this.currentuser === 'admin'
      },
      _currentPermissionsChanged: function() {

        // When permissions change, check if user can launch machines
        this.hasmachinelauncher = false

        const simulators_list = this.currentpermissions.find(function(resource){
          return resource.name === 'simulators_list'
        })

        if (!simulators_list)
          return

        this.hasmachinelauncher = !simulators_list.permissions[0].permissions.readOnly
      },
      properties: {
        portalurl: {
          type: String,
          value: 'https://localhost:4000',
          notify: true
        },
        token: {
          type: String,
          value: 'token not set',
          notify: true
        },
        isadmin: {
          type: Boolean,
          value: false,
          notify: true
        },
        currentuser: {
          type: String,
          value: 'current user not set',
          notify: true,
          observer: '_currentUserChanged'
        },
        currentpermissions: {
          type: Object,
          notify: true,
          observer: '_currentPermissionsChanged'
        },
        hasmachinelauncher: {
          type: Boolean,
          value: false,
          notify: true
        },
      },
    });
  })();
  </script>
</dom-module>
