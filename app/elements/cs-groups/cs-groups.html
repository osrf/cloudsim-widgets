<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-groups">
  <style>
    .admin-label {
      font-size: 0.8em;
      margin-left: 2em;
    }
    .miniButton {
      width: 2.2em;
    }
    .space {
      @apply(--layout-flex);
    }
    .blue {
      color: rgb(68, 138, 201);
    }
    .red {
      --iron-icon-fill-color: #f00;
    }
    .delete-button {
      background-color: #f35046;
      color: #fff;
    }
    .header {
      background-color: rgb(215, 215, 215);
      color: #353535;
      margin: 0;
      padding: 1em;
    }
    .main-content {
      text-align: left;
    }
    .content {
      overflow: auto;
      margin: 0;
      padding: 1em 2em 1em 1em;
    }
    .subcontent {
      padding-bottom: 2em;
    }
    .subheader {
      color: rgb(68, 138, 201);
    }
    .horizontal {
      @apply(--layout-horizontal);
    }
    .center {
      @apply(--layout-center);
      text-align: center;
    }
    .vertical {
      @apply(--layout-vertical);
    }
    paper-dialog {
      max-height: 40%;
      max-width: 30em;
      text-align: left;
    }
    h1 {
      margin-top: 0;
    }
    h4 {
      margin-bottom: 0;
    }
    paper-material {
      text-align: center;
      padding: 1em;
      margin: 1em;
      width: 10em;
    }
    .group-name {
      text-transform: none;
    }
  </style>
  <template>

    <gz-grant
      id="grant"
      url="[[url]]"
      token="[[token]]"
      on-permissionsupdated="_onAllPermissions"
      on-granted="_onGranted"
      on-got="_onSinglePermission"
    ></gz-grant>

    <gz-resources
      id="resources"
      config
      url="[[url]]"
      token="[[token]]"
      on-groupsupdated="_onGroups"
      on-created="_onGroupCreated"
    ></gz-resources>

    <paper-material elevation="1">

      <h1>
        <iron-icon
          icon="social:group"
          class="iconPadding"
        ></iron-icon>
        Teams
      </h1>

      <div class="main-content">
        <h4>Your teams</h4>

        <template is="dom-repeat" items="[[groups]]">
          <div>
            <paper-button flat on-tap="_onGroupDialog" class="group-name">
              [[item.data.name]]
            </paper-button>
          </div>
        </template>

        <template is="dom-if" if="[[cancreate]]">
          <h4>Create a team</h4>
          <div class="horizontal center">
            <paper-input
              style="padding-right: 1em"
              value={{creategroupname}}
              label="Team name">
            </paper-input>
            <paper-icon-button
              icon="social:group-add"
              on-tap="_onCreateGroup"
            ></paper-icon-button>
          </div>
        </template>
      </div>

    </paper-material>

    <!-- dialog -->
    <paper-dialog id="groupdialog" class="vertical">
      <h3 class="header">[[selectedgroup.data.name]]</h3>

      <div class="content">

        <!-- MEMBERS -->
        <div class="subcontent">
          <b class="subheader">Members</b>

          <template is="dom-repeat" items="[[selectedmembers]]">
            <div class="horizontal center">
              <template is="dom-if" if="[[isselectedadmin]]">
                <paper-icon-button
                  class="red miniButton"
                  icon="icons:remove-circle-outline"
                  id="[[item.username]]"
                  on-tap="_onRemoveUser">
                </paper-icon-button>
              </template>
              <span>[[item.username]]</span>
              <template is="dom-if" if="[[!item.permissions.readOnly]]">
                <span class="admin-label">Admin</span>
              </template>
            </div>
          </template>
        </div>

        <template is="dom-if" if="[[isselectedadmin]]">
          <!-- INVITE -->
          <div class="subcontent">
            <b class="subheader">Invite</b>

            <div class="horizontal">
              <div class="vertical">
                <!-- USERNAME INPUT-->
                <paper-input
                  style="padding-right: 1em"
                  value={{inviteusername}}
                  label="Username">
                </paper-input>

                <!-- ADMIN CHECKBOX-->
                <paper-checkbox
                  id="admincheckbox"
                  checked={{inviteadmin}}
                >
                Admin
                </paper-checkbox>
              </div>

              <div class="vertical">
                <div class="space"></div>

                <!-- INVITE BUTTON-->
                <paper-icon-button
                  icon="social:person-add"
                  id="invitebutton"
                  on-tap="_onInvite">
                </paper-icon-button>
              </div>
            </div>
          </div>

          <!-- DELETE -->
          <div class="subcontent center">
            <paper-button
              raised
              on-tap="_onDelete"
              class="delete-button">
              Delete team
            </paper-button>
          </div>
        </template>
      </div>
    </paper-dialog>

  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cs-groups',
      attached: function() {

        let that = this
        window.addEventListener('WebComponentsReady', function() {
          that.$.resources.getAll();
          that.$.grant.getall();
        });

        console.log('cs-groups widget attached!')
      },
      _onGroupDialog(e) {
        // Set selected group
        let groupName = e.target.innerText

        console.log(this.groups)

        const groupObj = this.groups.find(function(group){
          return group.data.name === groupName;
        })

        if (!groupObj) {
          console.error("Group [" + groupName + "] not found in:")
          console.error(this.groups)

          // Update the list, hopefully it will disappear
          this.$.resources.getAll();
        }

        this.selectedgroup = groupObj
        const list =  groupObj.permissions;

        this.isselectedadmin = !list[0].permissions.readOnly
        this.set('selectedmembers', list);

        // Open dialog
        var dialog = this.$.groupdialog
        if (dialog)
          dialog.open();
        else
          console.error("Group dialog not found.")
      },
      _onCreateGroup(e) {
        this.$.resources.createResource('group', {});
      },
      _onRemoveUser(e) {
        console.log("Remove user: " + e.target.parentElement.id)
      },
      _onInvite(e) {
        const data = { grantee: this.inviteusername,
                       resource: this.selectedgroup.name,
                       readonly: !this.inviteadmin}
        this.$.grant.grant(data);
      },
      _onDelete(e) {
        console.log("Delete team: " + this.selectedgroup)
      },

      /// Callback when groups have been updated
      _onGroups: function(e) {
        this.groups = this.$.resources.groups
      },

      /// Callback when a group has been created
      _onGroupCreated: function(e) {
        this.fire('notification', 'Created group "' + e.detail.result.data.name
            + '"');
      },

      /// Callback when permissions have been updated
      _onAllPermissions: function(e) {
        var permissions = this.$.grant.permissions

        const group = permissions.find(function(permission){
          return permission.name === 'group'
        })

        if (!group)
          return

        this.cancreate = !group.permissions[0].permissions.readOnly
      },

      /// Callback when a single permissions has been received.
      _onSinglePermission: function(e) {

        // We asked for the new permissions of the selected group
        if (e.detail.resource != this.selectedgroup.name) {
          console.error(e.detail);
          return;
        }

        this.selectedgroup = e.detail.result

        const list =  this.selectedgroup.permissions;
        this.isselectedadmin = !list[0].permissions.readOnly

        this.set('selectedmembers', list);
      },

      /// Callback when invited someone to the group
      _onGranted: function(e) {
        this.$.grant.get(this.selectedgroup.name);
        if (e.detail.success)
          this.fire('notification', 'User successfully invited.')
      },

      properties: {

        /// Array of groups for user.
        groups: {
          type: Array,
          value: [],
          notify: true
        },

        /// True if current user can create groups.
        cancreate: {
          type: Boolean,
          value: false,
          notify: true
        },

        /// True if current user is admin of selected group.
        isselectedadmin: {
          type: Boolean,
          value: false,
          notify: true
        },
      },
    });
  })();
  </script>
</dom-module>

