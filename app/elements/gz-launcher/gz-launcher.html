<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="gz-launcher">
  <template>
    <style>
      :host {
        display: block;
      }

      #gui {
        max-width:25em
      }

      #gui > input{
        float:right;
      }

      .terminal {
        height: 25em;
        overflow: auto;
        background-color: #300a24;
        color: white;
        padding: 1em;
        font-family: Ubuntu;
      }

    </style>

    <div><h1>{{title}}</h1></div>
    <div><h4>{{caption}}</h4></div>

    <div id="feedback" style="display:none">
      <span id="feedback_text"/>
    </div>

    <div id="gui">
      Simulation server URL:<input id=ugzUrl value="{{gzUrl::input}}"></input><br>
      User token:<input id=token value="{{token::input}}"></input><br>
      Command:<input id=cmdline value="{{cmd::input}}"></input><br>

      <button on-tap="tapRun" id="buttonRun">Run</button>
      <button on-tap="tapKill"id="buttonKill" style="display:none">Kill</button>
    </div>
    <div id="currentProcess" style="display:none; text-align:center">
      <h4>Process id: {{processPid}} - Status: {{processStatus}}</h4>
    </div>

    <div>
      <div id="console" class='terminal'  style="display:none">
      </div>
    </div>

  </template>

  <!--  <script src="/socket.io/socket.io.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.js"></script>

  <script>

  (function() {
    'use strict';

    Polymer({
      is: 'gz-launcher',
      tapRun: function() {
        this.connect()

        // Disable running
        this.$.ugzUrl.disabled = true
        this.$.token.disabled = true
        this.$.cmdline.disabled = true
        this.$.buttonRun.style.display = 'none'
        this.$.buttonKill.style.display = ''

        // Show current process
        this.$.currentProcess.style.display = ''
        this.processStatus = "Pending"

        // Emit
        const msg =  {
          cmd:'run',
          token: this.token,
          cmdline:cmdline.value,
          id:this.title}
        this.socket.emit('gz-launcher', msg)
      },
      attached: function() {
        console.log('gz-launcher widget attached!')
        this.connect()
      },
      connect: function() {
        // Initialize socket
        let socket = io(this.gzUrl)
        let that = this
        this.socket = socket
        const authMsg = {token: this.token}
        socket.on('connect', function () {
          console.log('authenticate: ' + authMsg )
          socket.on('authenticated', function () {
            console.log('socketio authenticated')
            socket.on('gz-launcher', function (msg) {
              // Show current process
              that.$.currentProcess.style.display = ''
              that.processPid = msg.pid
              that.processStatus = msg.state

              if (msg.state === 'ready') {
                that.$.buttonRun.disabled = false
                that.$.buttonKill.disabled = true
              }
              if (msg.state === 'running') {
                that.$.buttonRun.disabled = false
                that.$.buttonKill.disabled = false

                // Fill terminal
                that.$.console.style.display = ''
                if(msg.output) {
                  that.processOutput = msg.output
                  that.$.console.innerHTML = msg.output
                }
              }
              if (msg.state === 'closed') {
                // Reenable fields
                that.$.ugzUrl.disabled = false
                that.$.token.disabled = false
                that.$.cmdline.disabled = false
                that.$.buttonRun.style.display = ''
                that.$.buttonKill.style.display = 'none'

                // Clear terminal
                that.$.console.style.display = 'none'
                that.$.console.innerHTML = ''
              }
            })
          }).emit('authenticate', authMsg); // send the jwt
        })
      },
      tapKill: function()  {
        const msg = {cmd:'kill', pid: this.processPid}
        this.socket.emit('gz-launcher', msg)
      },
      properties: {
        // the title above the widget
        title: {
          type: String,
          value: 'Launch a simulation (gz-launcher)',
          notify: true
        },
        // the caption below the title
        caption: {
          type: String,
          value: 'Run a command on the simulation server.',
          notify: true
        },
        // the string that contains the terminal output
        processOutput: {
          type: String,
          value: '',
          notify: true
        },
        processPid: {
          type: String,
          value: '',
          notify: true
        },
        processStatus: {
          type: String,
          value: 'ready',
          notify: true
        },
        cmd: {
          type: String,
          value: 'gzserver --verbose',
          notify: true
        },
        gzUrl: {
          type: String,
          value: 'https://localhost:8080',
          notify: true
        },
        token: {
          type: String,
          value: 'xxxadminxxx',
          notify: true
        }
      }
    });
  })();
  </script>
</dom-module>
