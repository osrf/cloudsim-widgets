<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="gz-launcher">
  <template>
    <style>
      :host {
        display: block;
      }
      .terminal {
        height: 200px;
        overflow: auto;
      }

    </style>
    <div>Simulation run: <span>{{title}}</span> </div>
    <input id=cmdline value="{{cmd::input}}"></input>cmd<br>
    <input id=ugzUrl value="{{gzUrl::input}}"></input>url<br>
    <input id=token value="{{token::input}}"></input>token<br>
    <div>
      <button on-tap="tapRun" id="buttonRun">run</button>
      <button on-tap="tapKill"id="buttonKill">kill</button>
      process {{processPid}} status: {{processStatus}}
    </div>

    <div>
      <div id="console" class='terminal' >
      </div>
    </div>

  </template>

  <!--  <script src="/socket.io/socket.io.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.js"></script>

  <script>

  (function() {
    'use strict';

    Polymer({
      is: 'gz-launcher',
      tapRun: function() {
        console.log('run!')
        // this.$.console.innerHTML = ""
        this.processStatus = "pending"
        const msg =  {
          cmd:'run',
          token: this.token,
          cmdline:cmdline.value,
          id:this.title}
        this.socket.emit('gz-launcher', msg)
      },
      attached: function() {
        console.log('gz-launcher widget attached!')
        let socket = io(this.gzUrl)
        let that = this
        this.socket = socket
        const authMsg = {token: this.token}
        socket.on('connect', function () {
          console.log('authenticate: ' + authMsg )
          socket.on('authenticated', function () {
            console.log('socketio authenticated')
            socket.on('gz-launcher', function (msg) {
              // console.log("gz-launcher: " + JSON.stringify(msg))
              // that.$.console.innerHTML = msg.output
              that.processStatus = msg.state
              if(msg.output) {
                that.processOutput = msg.output
                that.$.console.innerHTML = msg.output
              }
              that.processPid = msg.pid
              if (msg.state === 'ready') {
                that.$.buttonRun.disabled = false
                that.$.buttonKill.disabled = true
              }
              if (msg.state === 'running') {
                that.$.buttonRun.disabled = false
                that.$.buttonKill.disabled = false
              }
              if (msg.state === 'closed') {
                that.$.buttonRun.disabled = false
                that.$.buttonKill.disabled = false
              }
            })
          }).emit('authenticate', authMsg); // send the jwt
        })
      },
      tapKill: function()  {
        const msg = {cmd:'kill', pid: this.processPid}
        console.log('kill! ' + JSON.stringify(msg))
        this.socket.emit('gz-launcher', msg)
      },
      properties: {
        // the title above the widget
        title: {
          type: String,
          value: 'gz-launcher',
          notify: true
        },
        // the string that contains the terminal output
        processOutput: {
          type: String,
          value: '',
          notify: true
        },
        processPid: {
          type: String,
          value: '',
          notify: true
        },
        processStatus: {
          type: String,
          value: 'ready',
          notify: true
        },
        cmd: {
          type: String,
          value: 'gzserver --verbose',
          notify: true
        },
        gzUrl: {
          type: String,
          value: 'https://localhost:4000',
          notify: true
        },
        token: {
          type: String,
          value: '123456',
          notify: true
        }
      }
    });
  })();
  </script>
</dom-module>
