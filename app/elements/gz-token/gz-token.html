<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="gz-token">
  <template>
    <style>
      #config {
        max-width:20em
      }

      #config > div{
        padding-top:0.5em;
      }

      #config > div > input{
        float:right;
      }
    </style>
    <iron-ajax
      id='ajax'
      url=''
      handle-as='json'
      on-response='hresponse'
      on-error="herror"
      debounce-duration='300'>
    </iron-ajax>

    <div id="config">
      <div><h1>{{title}}</h1></div>
      <div><h4>{{caption}}</h4></div>

      <div id="feedback" style="display:none">
        <span id="feedback_text"/>
      </div>

      <div>
        Auth server URL:<input id=url value="{{url::input}}"></input>
      </div>
      <div>
        Data (JSON):<input id=data value="{{data::input}}"></input>
      </div>
      <div>
        <button on-tap="tapToken" id="buttonToken">token</button>
      </div>
      <div>
        Token: {{token}}
      </div>
    </div>

  </template>

  <script>

  (function() {
    'use strict';

    Polymer({
      is: 'gz-token',

      tapLogin: function() {
        this.state = 'Requesting login'
        this.$.ajax.url = this.url + '/login'
        this.$.ajax.withCredentials = true
        this.$.ajax.generateRequest()
      },

      tapLogout: function() {

        if (window.navigator.userAgent.toLowerCase().indexOf("firefox") >= 0) {
          window.location = this.url.replace("https://", "https://toto:fakefake@") + "/logout"
          return;
        }
        this.$.feedback.style.display = 'none'
        this.state = 'Requesting logout'
        this.$.ajax.url = this.url + '/logout'
        this.$.ajax.generateRequest()
      },

      tapUsername: function() {
        this.state = ''
        this.fire('userprofile', {user: this.username})
      },

      tapToken: function() {
        this.state = 'Getting token'
        this.$.ajax.url = this.url + '/token'
        this.$.ajax.params = JSON.parse(this.data)
        this.$.ajax.withCredentials = true
        this.$.ajax.generateRequest()
      },
      hresponse: function(request) {
        this.$.feedback.style.display = ''

        let res = this.$.ajax.lastResponse

        if (res.login) {
          const success = res.login == "success" ? true : false
          if (!success)
          {
            this.$.feedback.style.color = 'red'
            this.$.feedback_text.textContent = "Fail!"
          }
          else
          {
            this.token = res.token
            this.set("username", res.username)
            this.$.feedback.style.color = 'blue'
            this.$.feedback_text.textContent = "User \"" + this.username + "\" logged in!"
            this.fire('login', {user: this.username})
          }
        }

        // Fill state
        console.log(request.detail.response)
      },
      herror: function(err) {
        this.fire('logout')
      },
      attached: function() {
        window.gztoken = this
        console.log('gz-token widget attached!')
      },
      // Triggered when the "config" property is changed
      _configChanged: function(newValue, oldValue) {
        this.$.config.style.display = newValue ? '' : 'none'
      },
      // Triggered when the "loginbutton" property is changed
      _loginbuttonChanged: function(newValue, oldValue) {
        this.$.loginbutton.style.display = newValue ? '' : 'none'
      },
      // Triggered when the "logoutbutton" property is changed
      _logoutbuttonChanged: function(newValue, oldValue) {
        this.$.logoutbutton.style.display = newValue ? '' : 'none'
      },
      // Triggered when the "usernamelabel" property is changed
      _usernamelabelChanged: function(newValue, oldValue) {
        this.$.usernamelabel.style.display = newValue ? '' : 'none'
      },
      properties: {
        // the title above the widget
        title: {
          type: String,
          value: 'Log into existing account (gz-token)',
          notify: true
        },
        // the caption under the title
        caption: {
          type: String,
          value: 'This widget allows the user to log into the system and get identity tokens from the cloudsim-auth server. These tokens are required when performing requests to cloudsim-portal and cloudsim-sim servers. A popup will show up to input username and password.',
          notify: true
        },
        data: {
          type: String,
          value: '{"role":"sim_runner"}',
          notify: true
        },
        url: {
          type: String,
          value: 'https://localhost:5050',
          notify: true
        },
        config: {
          type: Boolean,
          value: false,
          observer: '_configChanged'
        },
        username: {
          type: String,
          value: 'placeholder',
          notify: true
        }
      }
    })

  })()

  </script>
</dom-module>
