<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="gz-token">
  <template>
    <style>
      :host {
        display: block;
      }

      #gui {
        max-width:25em
      }

      #gui > input{
        float:right;
      }

    </style>
    <iron-ajax
      id='ajax'
      url=''
      handle-as='json'
      on-response='hresponse'
      headers='headers'
      debounce-duration='300'>
    </iron-ajax>

    <div><h1>{{title}}</h1></div>

    <div id="feedback" style="display:none">
      <span id="feedback_text"/>
    </div>
   <div><h4>{{caption}}</h4></div>

    <div id="gui">
      Auth server URL:<input id=url value="{{url::input}}"></input><br>

      Data (JSON):<input id=data value="{{data::input}}"></input><br>
    </div>
    <div>
      <button on-tap="tapLogin" id="buttonLogin">login</button>
      <button on-tap="tapLogout" id="buttonLogout">logout</button>
      <button on-tap="tapToken" id="buttonToken">token</button>
    </div>
    <div>
      State: {{state}}<br>
      Token: {{token}}
    </div>

  </template>

  <script>

  (function() {
    'use strict';

    Polymer({
      is: 'gz-token',

      tapLogin: function() {
        this.state = 'Requesting login'
        this.$.ajax.url = this.url + '/login'
        this.$.ajax.withCredentials = true
        this.$.ajax.generateRequest()
      },

      tapLogout: function() {
        this.state = 'Requesting logout'
        this.$.ajax.url = this.url + '/logout'
        this.$.ajax.generateRequest()
      },

      tapToken: function() {
        this.state = 'Getting token'
        this.$.ajax.url = this.url + '/token'
        this.$.ajax.params = JSON.parse(this.data)
        this.$.ajax.withCredentials = true
        this.$.ajax.generateRequest()
      },
      hresponse: function(request) {
        this.$.feedback.style.display = ''

        let res = this.$.ajax.lastResponse

        const success = res.login == "success" ? true : false
        if (!success)
        {
          this.$.feedback.style.color = 'red'
          this.$.feedback_text.textContent = "Fail!"
        }
        else
        {
          this.$.feedback.style.color = 'blue'
          this.$.feedback_text.textContent = "Success!"
        }


        // Fill state
        this.state = 'login in'
        console.log('hresponse, req: ' + request )
        console.log(request.detail.response)
        this.token = JSON.stringify(res)
        console.log(this.token)
      },
      attached: function() {
        console.log('gz-token widget attached!')
      },
      properties: {
        // the title above the widget
        title: {
          type: String,
          value: 'Log into existing account (gz-token)',
          notify: true
        },
        // the caption under the title
        caption: {
          type: String,
          value: 'This widget allows the user to log into the system and get identity tokens from the cloudsim-auth server. These tokens are required when performing requests to cloudsim-portal and cloudsim-sim servers. A popup will show up to input username and password.',
          notify: true
        },
        // the string that contains the terminal output
        state: {
          type: String,
          value: 'ready',
          notify: true
        },
        data: {
          type: String,
          value: '{"role":"sim_runner"}',
          notify: true
        },
        url: {
          type: String,
          value: 'https://localhost:5050',
          notify: true
        }
      }
    })

  })()

  </script>
</dom-module>
