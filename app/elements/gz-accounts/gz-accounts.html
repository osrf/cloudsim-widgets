<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="gz-accounts">
  <template>
    <style>
      :host {
        display: block;
      }

    </style>

    <iron-request id="xhr"
      method="POST"
    ></iron-request>

    <div id="config">
      Auth server URL: <input id=url value="{{url::input}}"></input><br>
    </div>

    <div id="gui">

      <div><h1>{{title}}</h1></div>
      <div><h4>{{caption}}</h4></div>

      <div id="feedback" style="display:none">
          <span id="feedback_text"/>
      </div>

      <button id="button_add"  on-tap = "tapAdd" >Add user</button>
      <button id="button_rem"  on-tap = "tapRem" >Remove user</button>
      <button id="button_hide" on-tap = "tapHide" style="display:none;" >Cancel</button>

      <div id="div_add_user" style="display:none">
          <input id="user"  type="text" placeholder="user name"/><br>
          <input id="pass1" type="password" placeholder="password"/><br>
          <input id="pass2" type="password" placeholder="confirm password"/><br>
          <button on-click="tapRegisterUser" >Register</button>
      </div>

      <div id="div_rem_user" style="display:none">
          <input id="ruser"  type="text" placeholder="user name"/><br>
          <input id="rpass" type="password" placeholder="password"/><br>
          <button on-tap="tapUnregisterUser" >Unregister</button>
      </div>
    </div>

  </template>

  <script>


  (function() {
    'use strict';

    Polymer({
      is: 'gz-accounts',
      // Attached
      attached: function() {
        console.log('gz-accounts widget [' + this.title + '] attached!')
      },
      // Triggered when the "gui" property is changed
      _guiChanged: function(newValue, oldValue) {
        this.$.gui.style.display = newValue ? '' : 'none'
      },
      // Triggered when the "config" property is changed
      _configChanged: function(newValue, oldValue) {
        this.$.config.style.display = newValue ? '' : 'none'
      },
      // Cancel tapped
      tapHide: function() {
        this.$.div_rem_user.style.display = 'none'
        this.$.div_add_user.style.display = 'none'
        this.$.button_hide.style.display = 'none'
        this.$.button_add.style.display = ''
        this.$.button_rem.style.display = ''
        this.$.feedback.style.display = 'none'
      },
      // Add user
      tapAdd: function() {
        this.$.div_add_user.style.display = 'block'
        this.$.div_rem_user.style.display = 'none'
        this.$.button_hide.style.display = ''
        this.$.button_add.style.display = 'none'
        this.$.button_rem.style.display = 'none'
        this.$.feedback.style.display = 'none'
        this.$.user.focus()
      },
      // Remove user
      tapRem: function() {
        this.$.div_add_user.style.display = 'none'
        this.$.div_rem_user.style.display = ''
        this.$.button_hide.style.display = ''
        this.$.button_add.style.display = 'none'
        this.$.button_rem.style.display = 'none'
        this.$.feedback.style.display = 'none'
        this.$.ruser.focus()
      },
      registerUser: function(_user, _pass) {
        var self = this;
        var x = this.post("/register", {"user":_user, "password": _pass}, function(err, res){
          console.log(res);
          if(err) {
            let msg = "Error connecting to server: " + err

            // Local feedback for config
            self.$.feedback.style.display = ''
            self.$.feedback.style.color = 'red'
            self.$.feedback_text.textContent = msg

            // Feedback to other widgets
            self.fire('register', {success: false, user: _user, msg: msg})
            return;
          }
          var j = JSON.parse(res)
          if(j.success)
          {
            let msg = 'User "' + _user + '" registered successfully';

            // Local feedback for config
            self.$.feedback.style.display = ''
            self.$.feedback.style.color = 'blue'
            self.$.feedback_text.textContent = msg

            // Feedback to other widgets
            self.fire('register', {success: true, user: _user, msg: msg})
          }
          else
          {
            let msg = 'Error: ' + j.error

            // Local feedback for config
            self.$.feedback.style.display = ''
            self.$.feedback.style.color = 'red'
            self.$.feedback_text.textContent = msg

            // Feedback to other widgets
            self.fire('register', {success: false, user: _user, msg: msg})
          }
        });
      },
      unregisterUser: function(_user, _pass) {
        var self = this;
        var x = this.post("/unregister", {"user":_user, "password": _pass}, function(err, res){
          if(err) {
            let msg = "Error connecting to server: " + err

            // Local feedback for config
            self.$.feedback.style.display = ''
            self.$.feedback.style.color = 'red'
            self.$.feedback_text.textContent = msg

            // Feedback to other widgets
            self.fire('unregister', {success: false, user: _user, msg: msg})
            return;
          }
          var j = JSON.parse(res)
          if(j.success)
          {
            let msg = 'User "' + _user + '" unregistered successfully'

            // Local feedback for config
            self.$.feedback.style.display = ''
            self.$.feedback.style.color = 'blue'
            self.$.feedback_text.textContent = 'User "' + _user + '" unregistered successfully'

            // Feedback to other widgets
            self.fire('unregister', {success: true, user: _user, msg: msg})
          }
          else
          {
            let msg = j.error

            // Local feedback for config
            self.$.feedback.style.display = ''
            self.$.feedback.style.color = 'red'
            self.$.feedback_text.textContent = msg

            // Feedback to other widgets
            self.fire('unregister', {success: false, user: _user, msg: msg})
          }
        });
      },
      // Register user
      tapRegisterUser: function() {
        // username can't be empty
        var user = this.$.user.value;
        var self = this;
        var close = function() {
          self.$.div_add_user.style.display = 'none'
          self.$.button_hide.style.display = 'none'
          self.$.button_add.style.display = ''
          self.$.button_rem.style.display = ''
        }
        if (user === "")
        {
          self.$.feedback.style.display = ''
          self.$.feedback.style.color = 'red'
          self.$.feedback_text.textContent = "User name can't be empty"
          return;
        }
        // verify passwords
        var pass = this.$.pass1.value;
        var pass2 = this.$.pass2.value;
        if (pass != pass2)
        {
          self.$.feedback.style.display = ''
          self.$.feedback.style.color = 'red'
          self.$.feedback_text.textContent = "Passwords don't match"
          return;
        }
        if(pass === "")
        {
          self.$.feedback.style.display = ''
          self.$.feedback.style.color = 'red'
          self.$.feedback_text.textContent = "Password can't be empty"
          return;
        }

        this.registerUser(user, pass)
      },
      // Unregister user
      tapUnregisterUser: function() {
        var user = this.$.ruser.value;
        var self = this;
        var close = function() {
            self.$.div_rem_user.style.display = 'none'
            self.$.button_hide.style.display = 'none'
            self.$.button_add.style.display = ''
            self.$.button_rem.style.display = ''
        }
        if (user === "")
        {
          self.$.feedback.style.display = ''
          self.$.feedback.style.color = 'red'
          self.$.feedback_text.textContent = "User name can't be empty"
          return;
        }
        var pass = this.$.rpass.value;
        if (pass === "")
        {
          self.$.feedback.style.display = ''
          self.$.feedback.style.color = 'red'
          self.$.feedback_text.textContent = "Password is empty"
          return;
        }

        this.unregisterUser(user, pass);
      },

      // Helper function for posting http requests
      post: function (route, data, cb) {
        console.log('gz-accounts.post', ' ', data, ',', route)
        const xhr = document.createElement('iron-request')
        const options = {
            method: 'POST',
            url: this.url + route,
            handleAs: 'json',
            headers: {'content-type': 'application/json'},
            body: data
        }
        xhr.send(options).then(
            function() {
              console.log('POST success')
              console.log(xhr.response)
              cb(null, xhr.response)
            },
            function(err) {
              console.log('POST FAILED ' + err)
              cb(err.message)
            }
        )
      },

/*
      post: function (route, data, cb) {
        var xmlhttp;
        xmlhttp=new XMLHttpRequest();
        xmlhttp.onreadystatechange=function() {
            console.log("READY: " + xmlhttp.readyState +
              " STATUS: " + xmlhttp.status);
            if (xmlhttp.readyState==4)
            {
              if(xmlhttp.status == 0) cb("Something went wrong, does the server exist?");
              if(xmlhttp.status == 500) cb("500 Internal Server Error");
              if(xmlhttp.status == 501) cb("501 Not Implemented");
              if(xmlhttp.status == 502) cb("502 Bad Gateway");
              if(xmlhttp.status == 503) cb("503 Service Unavailable");
              if(xmlhttp.status == 504) cb("504 Gateway Timeout");
              if(xmlhttp.status == 505) cb("505 HTTP Version Not Supported");
              if(xmlhttp.status == 506) cb("506 Transparent content " +
                "negotiation for the request results in a circular reference.");
              if(xmlhttp.status == 507) cb("507 Insufficient Storage (WebDAV)");
              if(xmlhttp.status == 508) cb("508 Loop Detected (WebDAV)");
              if(xmlhttp.status == 509) cb("509 Bandwidth Limit Exceeded (Apache bw/limited extension)");
              if(xmlhttp.status == 510) cb("510 Further extensions to the " +
                "request are required for the server to fulfil it.");
              if(xmlhttp.status == 511) cb("511 Network Authentication Required");

              if(xmlhttp.status >= 200 && xmlhttp.status < 300) {
                  var r = xmlhttp.responseText;
                  cb(null, r)
              }
            }
            else
            {
              if(xmlhttp.status == 404) cb("404");
            }
        }
        const completeUrl = this.url + route
        xmlhttp.open("POST", completeUrl, true);
        xmlhttp.setRequestHeader("Content-Type","application/json");
        xmlhttp.send(JSON.stringify(data));
      },
*/
      properties: {
        // the title above the widget
        title: {
          type: String,
          value: 'Create / remove accounts (gz-accounts)',
          notify: true
        },
        // the caption under the title
        caption: {
          type: String,
          value: 'Add and remove users to the authentication server. This needs \
 a server that implements the authentication (see cloudsim-auth).',
          notify: true
        },
        // Server URL
        url: {
          type: String,
          value: 'https://localhost:5050',
          notify: true
        },
        gui: {
          type: Boolean,
          value: false,
          observer: '_guiChanged'
        },
        config: {
          type: Boolean,
          value: false,
          observer: '_configChanged'
        }
      }
    });
  })();
  </script>
</dom-module>
