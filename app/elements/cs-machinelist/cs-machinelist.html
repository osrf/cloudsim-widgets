<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-machinelist">
  <style>
  </style>
  <template>

    <gz-simulatorq
      id="simulatorq"
      token={{token}}
      on-simulatorqupdated="onSimulatorqUpdated"
      url={{portalurl}}
    ></gz-simulatorq>

    <template is="dom-repeat" items="{{listitems}}" id="list">
      <cs-machineitem
        itemid="[[item.id]]"
        stat="[[item.status]]"
        machine_ip="[[item.machine_ip]]"
        launch_date="[[item.launch_date]]"
        termination_date="[[item.termination_date]]"
        username="[[item.owner.username]]"
        region="[[item.region]]"
        token="{{token}}"
        portalurl="{{portalurl}}"
      ></cs-machineitem>
    </template>

  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'cs-machinelist',
      // Attached
      attached: function() {
        this.refresh()
        console.log('cs-machinelist widget attached!')
      },
      onSimulatorqUpdated: function(e) {
        if (e.detail.success)
        {
          this.updateList(e.detail.items);
        }
      },
      updateList: function(items) {
        this.sortByReverseLaunchDate(items);

        // The portal sends periodic updates even if there are no changes.
        // Check if there are status updates
        if (items.length == this.listitems.length)
        {
          let i = 0;
          while (i < items.length && items[i].status == this.listitems[i].status &&
              items[i].machine_ip == this.listitems[i].machine_ip)
          {
            ++i;
          }
          if (i == items.length)
            return;
        }

        this.set('listitems', items);
      },
      refresh() {
        this.$.simulatorq.tapGet();
      },
      sortByReverseLaunchDate: function(items) {
        items.sort(this.compareDates)
      },
      compareDates: function(a, b) {
        let aDate = new Date(a.launch_date)
        let bDate = new Date(b.launch_date)
        if (aDate < bDate)
            return 1;
        if (aDate > bDate)
            return -1;
        return 0;
      },
      properties: {
        portalurl: {
          type: String,
          value: 'https://localhost:4000',
          notify: true
        },
        token: {
          type: String,
          value: 'placeholder',
          notify: true
        },
        listitems: {
          type: Array,
          value: [],
          notify: true
        },
      },
    });
  })();
  </script>
</dom-module>
