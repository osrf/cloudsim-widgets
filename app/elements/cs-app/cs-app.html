<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/elements.html">

<dom-module id="cs-app">

  <template>
    <style>

      paper-drawer-panel {
        /* space for toolbar */
        margin-top: 64px;
        height: calc(100% - 64px);
      }

      /* Height of the scroll area */
      .content {
        overflow: auto;
        background-color: #f3f3f3;
      }

      paper-material {
        margin: 1em;
        padding: 1em;
      }

      #errorToast {
        --paper-toast-background-color: #e74747
      }
      #msgToast {
        --paper-toast-background-color: rgb(43, 137, 222)
      }
    </style>

    <!-- For login / logout -->
    <gz-token
      id="token"
      url=[[authurl]]
      auth0_id=[[auth0_id]]
      auth0_domain=[[auth0_domain]]
      on-login="_onLogin"
      on-logout="_onLogout"
    ></gz-token>

    <!-- For permissions in the portal -->
    <gz-grant
      id="grant"
      url=[[portalurl]]
      token=[[token]]
      on-permissionsupdated="_onPermissions"
    ></gz-grant>

    <paper-toast
      id="errorToast"
      class="fit-bottom"
      duration="0">
      <paper-button onclick="errorToast.toggle()" class="yellow-button">Got it!</paper-button>
    </paper-toast>

    <paper-toast
      id="msgToast"
      class="fit-bottom">
    </paper-toast>

    <!-- Main Toolbar -->
    <cs-toptoolbar
      id="toptoolbar"
      authurl="[[authurl]]"
      currentuser="[[currentuser]]"
      loggedin="[[loggedin]]"
      on-loginrequest="requestLogin"
      on-logoutrequest="requestLogout"
    ></cs-toptoolbar>

    <!-- Parent pages: secure / public -->
    <iron-pages attr-for-selected="data-route" selected="{{topLevelRoute}}">

      <!-- Public routes -->
      <section data-route="stayintouch">
        <cs-stayintouchpage></cs-stayintouchpage>
      </section>

      <section data-route="home" style="padding: 0em">
        <cs-home/>
      </section>

      <!-- SRC public routes -->
      <section data-route="src" style="padding: 0em">
        <cs-srchome/>
      </section>

      <section data-route="src-register">
        <cs-srcregister
          loggedin="[[loggedin]]"
          token="[[token]]"
          competitor="[[issrccompetitor]]"
        ></cs-srcregister>
      </section>

      <!-- ARIAC public routes -->
      <section data-route="ariac" style="padding: 0em">
        <cs-ariachome/>
      </section>

      <section data-route="ariac-register">
        <cs-ariacregister
          loggedin="[[loggedin]]"
        ></cs-ariacregister>
      </section>

      <!-- SASC public routes -->
      <section data-route="sasc" style="padding: 0em">
        <cs-saschome/>
      </section>

      <!-- Secure routes -->
      <section data-route="secure">

        <!-- Drawer / panel -->
        <paper-drawer-panel id="paperDrawerPanel">

          <!-- Main Menu -->
          <cs-menu
            id="menu"
            drawer
            fixed
          ></cs-menu>

          <!-- Main Content -->
          <div class="content" main id="headerPanelMain">

            <iron-pages attr-for-selected="data-route" selected="{{secureRoute}}">

              <!-- Dashboard -->
              <section data-route="dashboard">
                <cs-dashboard
                  id="dashboard"
                  authurl=[[authurl]]
                  portalurl="[[portalurl]]"
                  token="[[token]]"
                  currentuser="[[currentuser]]"
                  currentpermissions="[[currentpermissions]]"
                ></cs-dashboard>
              </section>

              <!-- Profile -->
              <section data-route="profile">
                <cs-profile
                  authurl=[[authurl]]
                  token="[[token]]"
                  currentuser="[[currentuser]]"
                ></cs-profile>
              </section>

              <!-- SRC secure routes -->
              <section data-route="src">

                <iron-pages attr-for-selected="data-route" selected="{{srcRoute}}">

                  <section data-route="home">
                    <cs-srchome/>
                  </section>

                  <section data-route="competitor">
                    <cs-srccompetitor/>
                  </section>

                  <section data-route="organizer">
                    <cs-srcorganizer
                      token="[[token]]"
                      authurl="[[authurl]]"
                    ></cs-srcorganizer>
                  </section>

                  <section data-route="leaderboard">
                    <cs-srcleaderboard/>
                  </section>

                  <section data-route="register">
                    <cs-srcregister
                      loggedin="[[loggedin]]"
                      token="[[token]]"
                    ></cs-srcregister>
                  </section>

                </iron-pages>

              </section>

              <!-- ARIAC secure routes -->
              <section data-route="ariac">

                <iron-pages attr-for-selected="data-route" selected="{{ariacRoute}}">

                  <section data-route="home">
                    <cs-ariachome/>
                  </section>

                  <section data-route="competitor">
                    <cs-ariaccompetitor/>
                  </section>

                  <section data-route="organizer">
                    <cs-ariacorganizer/>
                  </section>

                  <section data-route="leaderboard">
                    <cs-ariacleaderboard/>
                  </section>

                  <section data-route="register">
                    <cs-ariacregister
                      loggedin="[[loggedin]]"
                      currentuser="[[currentuser]]"
                    ></cs-ariacregister>
                  </section>

                </iron-pages>

              </section>

              <!-- SASC secure routes -->
              <section data-route="sasc">

                <iron-pages attr-for-selected="data-route" selected="{{sascRoute}}">

                  <section data-route="home">
                    <cs-saschome/>
                  </section>

                  <section data-route="kiosk">
                    <cs-sasckiosk
                      token="[[token]]"
                      portalurl="[[portalurl]]"
                      keysurl="[[keysurl]]"
                      authurl="[[authurl]]"
                    ></cs-sasckiosk>
                  </section>

                </iron-pages>

              </section>

            </iron-pages>
          </div>

        </paper-drawer-panel>

      </section> <!-- secure -->

    </iron-pages>

  </template>

  <script>

    Polymer({

      is: 'cs-app',

      attached: function() {

        // Get configuration from environment variables
        this.authurl = getConfig().auth
        this.portalurl = getConfig().portal
        this.keysurl = getConfig().keys
        this.auth0_id = getConfig().auth0_id
        this.auth0_domain = getConfig().auth0_domain

        // Sets app default base URL
        this.baseUrl = '/';

        this.addEventListener('notification', function(e) {
          this.openToast(e);
        });

        this.addEventListener('error', function(e) {
          this.openErrorToast(e);
        });
        console.log('cs-app widget attached!')
      },
      openToast: function(e) {
        let msg = e.detail
        if (e.detail.msg)
          msg = e.detail.msg
        if (e.detail.type === "error")
        {
          this.$.errorToast.text = msg
          this.$.errorToast.open()
        }
        else
        {
          this.$.msgToast.text = msg
          this.$.msgToast.open()
        }
      },
      openErrorToast: function(e) {
        let msg = e.detail
        if (e.detail.msg)
          msg = e.detail.msg
        this.$.errorToast.text = msg
        this.$.errorToast.open()
      },
      requestLogin() {
        this.$.token.tapLogin();
      },
      requestLogout() {
        this.$.token.tapLogout();
      },
      _onLogin(e) {
        this.loggedin = true
        this.token = e.detail.token;
        this.currentuser = e.detail.identities[0];
        this.identities = e.detail.identities;

        // SRC
        // For now, simulating 3 users:
        // -admin is a competition organizer
        // -src_organizer is also a competition organizer
        // -src_competitor is a competitor
        this.issrcorganizer = (this.currentuser === getConfig().admin ||
                               this.identities.indexOf("src-admins") > -1);
        this.issrccompetitor = (!this.issrcorganizer &&
            this.identities.indexOf("src-competitors") > -1);

        this.$.menu.issrcuser = this.issrccompetitor || this.issrcorganizer
        this.$.dashboard.issrcuser = this.issrccompetitor || this.issrcorganizer

        // ARIAC
        // For now, simulating 3 users:
        // -admin is a competition organizer
        // -ariac_organizer is also a competition organizer
        // -ariac_competitor is a competitor
        this.isariacorganizer = (this.currentuser === getConfig().admin ||
                               this.identities.indexOf("ariac-admins") > -1);
        this.isariaccompetitor = (!this.isariacorganizer &&
            this.identities.indexOf("ariac-competitors") > -1);

        this.$.menu.isariacuser = this.isariaccompetitor || this.isariacorganizer
        this.$.dashboard.isariacuser = this.isariaccompetitor || this.isariacorganizer

        // SASC
        this.issascadmin = (this.currentuser === getConfig().admin ||
                               this.identities.indexOf("sasc-admins") > -1);
        this.issasccompetitor = (!this.issascadmin &&
            this.identities.indexOf("sasc-competitors") > -1);

        this.$.menu.issascuser = this.issasccompetitor || this.issascadmin
        this.$.dashboard.issascuser = this.issasccompetitor || this.issascadmin

        // Get permissions from gz-grant
        this.$.grant.getall();

        // Reload page with logged in routes
        page(window.location.pathname);
      },
      _onLogout(e) {
        this.loggedin = false

        // Reload page with logged out routes
        page('/');
      },
      _onPermissions: function(e) {
        this.currentpermissions = this.$.grant.permissions

        // Reload page with user routes
        page(window.location.pathname);
      },
      properties: {
        authurl: {
          type: String,
          value: 'https://localhost:5050',
          notify: true
        },
        portalurl: {
          type: String,
          value: 'https://localhost:4000',
          notify: true
        },
        keysurl: {
          type: String,
          value: 'https://localhost:4001',
          notify: true
        },
        auth0_id: {
          type: String,
          value: '',
          notify: true
        },
        auth0_domain: {
          type: String,
          value: '',
          notify: true
        },
        loggedin: {
          type: Boolean,
          value: false,
          notify: true
        },
        hasmachinelauncher: {
          type: Boolean,
          value: false,
          notify: true
        },
        token: {
          type: String,
          value: '',
          notify: true
        },
        currentuser: {
          type: String,
          value: '',
          notify: true
        },
        issrccompetitor: {
          type: Boolean,
          value: false,
          notify: true
        },
        issrcorganizer: {
          type: Boolean,
          value: false,
          notify: true
        },
        isariaccompetitor: {
          type: Boolean,
          value: false,
          notify: true
        },
        isariacorganizer: {
          type: Boolean,
          value: false,
          notify: true
        },
      }
    });

  </script>

</dom-module>

